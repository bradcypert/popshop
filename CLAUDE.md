# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Popshop is a Dart CLI application built using Very Good CLI template. It follows a command-based architecture with a main command runner that handles subcommands like `serve` and `update`.

## Development Environment

This project uses `mise` for environment management with Dart SDK 3.8.2. The configuration is defined in `.mise.toml`.

### Initial Setup
```bash
# Trust the mise configuration (first time only)
mise trust

# Install tools (Dart SDK)
mise install

# Install dependencies and build
mise run dev
```

### Using Dart Commands
```bash
# Option 1: Use mise tasks (recommended)
mise run deps      # dart pub get
mise run test      # dart test
mise run analyze   # dart analyze

# Option 2: Direct execution through mise
mise exec -- dart <command>
mise exec -- dart pub get
mise exec -- dart test
```

## Available Mise Tasks

The project includes predefined mise tasks for common operations:

### Development Tasks
```bash
mise run dev           # Install dependencies and build (setup)
mise run deps          # Install Dart dependencies (dart pub get)
mise run build         # Build version information (dart run build_runner build)
mise run verify        # Verify build (dart run build_verify)
```

### Testing Tasks
```bash
mise run test          # Run all tests
mise run test-coverage # Run tests with coverage report
```

### Code Quality Tasks
```bash
mise run analyze       # Analyze Dart code
mise run format        # Format Dart code
mise run fix          # Apply automated fixes
```

### Running the CLI
```bash
mise run run          # Run the CLI (dart run bin/popshop.dart)

# Or with arguments using mise exec:
mise exec -- dart run bin/popshop.dart serve
mise exec -- dart run bin/popshop.dart serve --port 8080
mise exec -- dart run bin/popshop.dart --version
mise exec -- dart run bin/popshop.dart --help
```

### Manual Commands (when needed)
```bash
# Generate and view coverage report (after test-coverage)
genhtml coverage/lcov.info -o coverage/
open coverage/index.html

# Run single test file
mise exec -- dart test test/src/commands/serve_command_test.dart

# Check dependencies
mise exec -- dart pub deps
```

## Architecture

### Core Structure
- `bin/popshop.dart` - Entry point that creates and runs PopshopCommandRunner
- `lib/src/command_runner.dart` - Main CommandRunner with logging, version checking, and command registration
- `lib/src/commands/` - Individual command implementations
- `lib/src/version.dart` - Auto-generated version file

### Command System
The CLI uses the `args` package CommandRunner pattern:
- Commands extend `Command<int>` and return exit codes
- Commands are registered in PopshopCommandRunner constructor
- Built-in support for completion, logging levels, and update checking

### Key Dependencies
- `args` - Command-line argument parsing
- `cli_completion` - Shell completion support  
- `mason_logger` - Structured logging with color support
- `pub_updater` - Automatic update checking
- `very_good_analysis` - Dart linting rules

### Testing
- Uses standard Dart `test` package
- `mocktail` for mocking
- Tests mirror the lib structure in `test/src/`
- Build verification with `build_verify`

## Development Notes

- The project uses Very Good Analysis for linting with `public_member_api_docs: false`
- Version information is auto-generated by build_runner
- Update checking is built-in and runs after most commands
- CLI supports verbose logging with `--verbose` flag
- All commands should return proper exit codes for shell integration